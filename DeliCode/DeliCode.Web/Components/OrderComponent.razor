@inject ICartService CartService
@inject IOrderService OrderService
@inject NavigationManager NavManager
SessionsId: @cart.SessionId

Order Total Price: @orderModel.TotalPrice()

<div class="container">
    <div class="row">
        <div class="col-md-12 col-lg-5">
            <div class="card">
                <div class="card-content">
                    <div class="card-body">
                        <h4 style="color: #5e676f">
                            Varukorg
                            <svg class="float-right bi bi-cart4" style="        color: orangered
" xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5zM3.14 5l.5 2H5V5H3.14zM6 5v2h2V5H6zm3 0v2h2V5H9zm3 0v2h1.36l.5-2H12zm1.11 3H12v2h.61l.5-2zM11 8H9v2h2V8zM8 8H6v2h2V8zM5 8H3.89l.5 2H5V8zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0z" />
                            </svg>
                        </h4>

                        @foreach (var item in cart.Items)
                        {

                            <div class="list list-row " id="sortable" data-sortable-id="0" aria-dropeffect="move">
                                <div class="list-item" data-id="13" data-item-sortable-id="0" draggable="true" role="option" aria-grabbed="false" style="">
                                    <div class="flex">

                                        <a @onclick="@(()=>NavigateToProduct(item.Product.Id))" class="item-author text-color font-weight-bold" data-abc="true">@item.Product.Name</a>
                                        <div class="item-except text-muted text-sm h-1x">x @item.Quantity</div>
                                    </div>
                                    <div class="no-wrap">
                                        <div class="item-date text-muted text-sm d-none d-md-block font-weight-bold">@item.Product.Price :-</div>
                                    </div>
                                </div>
                            </div>
                        }
                        <hr />
                        @selectedDeliverytype
                        Total: <span class="font-weight-bold" style="color: forestgreen">@orderModel.TotalPrice() :-</span>
                    </div>
                </div>
            </div>
        </div>






        @if (isValidPersonalDetails)
        {
            <div class="col-md-12 col-lg-5">
                <div class="card">
                    <div class="card-content">
                        <div class="card-body">
                            <h4 style="color: #5e676f">
                                Välj leveranssätt
                                <svg class="float-right bi bi-cart4" style="        color: orangered
" xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M0 2.5A.5.5 0 0 1 .5 2H2a.5.5 0 0 1 .485.379L2.89 4H14.5a.5.5 0 0 1 .485.621l-1.5 6A.5.5 0 0 1 13 11H4a.5.5 0 0 1-.485-.379L1.61 3H.5a.5.5 0 0 1-.5-.5zM3.14 5l.5 2H5V5H3.14zM6 5v2h2V5H6zm3 0v2h2V5H9zm3 0v2h1.36l.5-2H12zm1.11 3H12v2h.61l.5-2zM11 8H9v2h2V8zM8 8H6v2h2V8zM5 8H3.89l.5 2H5V8zm0 5a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0zm9-1a1 1 0 1 0 0 2 1 1 0 0 0 0-2zm-2 1a2 2 0 1 1 4 0 2 2 0 0 1-4 0z" />
                                </svg>
                            </h4>

                            @foreach (var item in deliveryOptions)
                            {

                                <div class="list list-row " id="sortable" data-sortable-id="0" aria-dropeffect="move">
                                    <div class="list-item" data-id="13" data-item-sortable-id="0" draggable="true" role="option" aria-grabbed="false" style="">
                                        <div class="flex">

                                            <a @onclick="@(()=>SelectDelivery(item.Key))" class="btn btn-outline-secondary" data-abc="true">@item.Key</a>

                                        </div>
                                        <div class="no-wrap">
                                            <div class="item-date text-muted text-sm d-none d-md-block font-weight-bold">@item.Value :-</div>
                                        </div>
                                    </div>
                                </div>
                            }
                            <hr />
                            Total: <span class="font-weight-bold" style="color: forestgreen">@orderModel.TotalPrice() :-</span>
                        </div>
                    </div>
                </div>
            </div>
        }





        @if (!isValidPersonalDetails)
        {

            <div class="col-md-12 col-lg-7">
                <div class="card">
                    <div class="card-content">
                        <div class="card-body">
                            <div class="page-content page-container" id="page-content">

                                <EditForm Model="@orderModel" OnValidSubmit="@SavePersonalDetails">
                                    <DataAnnotationsValidator />
                                    <ValidationSummary />
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Förnamn</label>
                                            <InputText class="form-control" id="firstname" @bind-Value="orderModel.FirstName" />
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Efternamn</label>
                                            <InputText class="form-control" id="lastname" @bind-Value="orderModel.LastName" />
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Epost</label>
                                            <InputText class="form-control" id="email" @bind-Value="orderModel.Email" />
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Adress</label>
                                            <InputText class="form-control" id="address" @bind-Value="orderModel.Address" />
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Postnummer</label>
                                            <InputText class="form-control" id="zipcode" @bind-Value="orderModel.ZipCode" />
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Stad</label>
                                            <InputText class="form-control" id="city" @bind-Value="orderModel.City" />
                                        </div>
                                        <div class="form-group col-md-6">
                                            <label>Land</label>
                                            <InputText class="form-control" id="country" @bind-Value="orderModel.Country" />
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Telefon</label>
                                            <InputText class="form-control" id="phone" @bind-Value="orderModel.Phone" />
                                        </div>
                                    </div>
                                    <div class="form-row">
                                        <div class="form-group col-md-6">
                                            <label>Extra information</label>
                                            <InputTextArea class="form-control" id="shippingnotes" @bind-Value="orderModel.ShippingNotes" />
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" type="submit">Välj leveranssätt</button>
                                </EditForm>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        } 
        @if (isValidPersonalDetails && isDeliverySelected)
        {
            <div class="col-md-12 col-lg-5">
                <div class="card">
                    <div class="card-content">
                        <div class="card-body">
                            <div class="page-content page-container" id="page-content">

                                <button class="btn btn-primary" @onclick="@PlaceOrder">Beställ</button>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
         }
    </div>

</div>


@code {
    [Parameter]
    public string UserId { get; set; }

    private Order orderModel = new Order();
    private Cart cart = new Cart();
    private string userid;
    private bool isValidPersonalDetails = false;
    private bool isDeliverySelected = false;
    private string selectedDeliverytype;
    private Dictionary<string, decimal> deliveryOptions = new Dictionary<string, decimal>();

    protected override async Task OnInitializedAsync()
    {
        cart = await CartService.GetCart();
        foreach (var item in cart.Items)
        {
            orderModel.OrderProducts.Add(new OrderProduct { Name = item.Product.Name, Price = item.Product.Price, ProductId = item.Product.Id, Quantity = item.Quantity });
        }
        deliveryOptions.Add("Hemleverans", 299);
        deliveryOptions.Add("Hämta i butik", 0);
        StateHasChanged();
    }

    private void SavePersonalDetails()
    {
        isValidPersonalDetails = true;
    }

    private void NavigateToProduct(Guid productid)
    {
        NavManager.NavigateTo("/product/Details?productId=" + productid.ToString(), true);
    }

    private void SelectDelivery(string selectedDelivery)
    {
        var deliveryprice = deliveryOptions.SingleOrDefault(x => x.Key == selectedDelivery).Value;
        orderModel.ShippingPrice = deliveryprice;
        selectedDeliverytype = selectedDelivery;
        isDeliverySelected = true;
        StateHasChanged();
    }

    private async Task PlaceOrder()
    {
        @if (userid != null)
        {
            orderModel.UserId = userid;
        }
        try
        {
            var order = await OrderService.PlaceOrder(orderModel);
            NavManager.NavigateTo("/", true);
        }
        catch
        {
            isDeliverySelected = false;
            isValidPersonalDetails = false;
        }
    }
}
